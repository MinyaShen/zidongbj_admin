<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport"
		content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="format-detection" content="telephone=no">
	<title>用户管理</title>
	<!-- 引入css -->
	<link rel="stylesheet" type="text/css" href="../static/layui/css/layui.css" />
	<link rel="stylesheet" type="text/css" href="../static/css/public.css" />
	<link rel="stylesheet" type="text/css" href="../static/css/table.css" />

	<style>
		.layui-layer-iframe {
			border-radius: 10px !important;
			overflow: hidden;
		}
	</style>
</head>

<body>
	<div class="alarm-wrapper">
		<h3 class="alarm-page-title">用户管理</h3>
		<div class="alarm-content">
			<div class="alarm-table-toolbar">
				<div class="layui-form alarm-filter-form">
					<div class="layui-form-item">
						<label class="layui-form-label">关键字：</label>
						<div class="layui-input-block">
							<input id="keyword" type="text" required lay-verify="required" placeholder="责任人姓名、电话"
								autocomplete="off" class="layui-input">
						</div>
					</div>

					<div class="layui-form-item alarm-form-btns">
						<div class="layui-input-block">
							<button id="search" data-type="search"
								class="layui-btn alarm-btn-primary alarm-btn-size alarm-btn-search">查询</button>
						</div>
					</div>
				</div>

				<div class="t-head-toolbar-btn">
					<button id="openAddUser" type="button"
						class="layui-btn alarm-btn-size alarm-btn-success">添加</button>
					<button id="deleteUser" type="button" class="layui-btn alarm-btn-size alarm-btn-danger">删除</button>
				</div>
			</div>
			<table id="noticeData" lay-filter="noticeData"></table>
			<!-- <script type="text/html" id="titleTpl">
				{{#  if(d.id < 100){ }}
				  <a href="/detail/{{d.id}}" class="layui-table-link">{{d.title}}</a>
				{{#  } else { }}
				  {{d.title}}(普通用户)
				{{#  } }}
			  </script> -->

			<script type="text/html" id="tableBar">
				<a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
				{{#  if(d.roleType == 1 || d.roleType == 2){ }}
				<a class="layui-btn layui-btn-xs" lay-event="bindpoint">点位操作</a>
				{{#  } }}

				{{#  if(d.roleType == 1){ }}
				<a class="layui-btn layui-btn-xs" lay-event="bindsub">设置子用户</a>
				{{#  } }}
			</script>
		</div>
	</div>

	<script src="../static/layui/layui.js"></script>
	<script src="../static/js/jquery.min.js"></script>
	<script src="../static/js/common.js"></script>
	<script>
		layui.use(['laypage', 'jquery', 'table', 'form', 'layer'], function () {
			var table = layui.table;
			var layer = layui.layer; // 弹出层组件引入

			//添加用户
			layui.$("#openAddUser").on('click', function () {
				layer.open({
					type: 2,
					title: "信息编辑",
					area: ['600px', '400px'],
					content: "../alerts/addUser.html"
				});
			})


			//监听单条数据工具条 
			table.on('tool(noticeData)', function (obj) { //注：tool 是工具条事件名，test 是 table 原始容器的属性 lay-filter="对应的值"
				var data = obj.data; //获得当前行数据
				var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）

				if (layEvent === 'edit') { //编辑
					layer.open({
						type: 2,
						title: "信息编辑",
						area: ['600px', '300px'],
						content: "../alerts/editUser.html?userId=" + data.userId
					});
				} else if (layEvent === 'bindpoint') { //绑定点位
					layer.open({
						type: 2,
						title: "绑定点位",
						area: ['500px', '420px'],
						content: "../alerts/bindpoint.html?userId=" + data.userId
					});
				} else if (layEvent === 'bindsub') { //绑定子网点
					layer.open({
						type: 2,
						title: "设置子网点",
						area: ['600px', '400px'],
						content: "../alerts/bindsub.html?userId=" + data.userId
					});
				}
			});


			// 删除用户
			$('#deleteUser').on('click', function () {
				var tempdata = [];
				var checkStatus = table.checkStatus('noticeData'); //idTest 即为基础参数 id 对应的值
				console.log(checkStatus.data)
				console.log(checkStatus.data.length) //获取选中行数量，可作为是否有选中行的条件
				var temp = checkStatus.data; //获取选中行的数据
				for (var i = 0; i < temp.length; i++) {
					tempdata.push(temp[i].userId)
				}
				var data = tempdata.join(',')

				$.ajax({
					url: baseUrl + "/user/delUser",
					data: {
						ids: data
					},
					method: 'GET',
					contentType: 'application/json',
					success: function (result) {
						table.reload('noticeData', {
							page: {
								curr: 1 //从第一页开始
							},
							url: baseUrl + '/user/queryUsers'
						});
						layer.msg("删除成功", {
							icon: 1
						})
					}
				});

			})

			//表格渲染
			table.render({
				elem: '#noticeData',
				url: baseUrl + '/user/queryUsers',
				page: true,
				skin: 'line',
				limit: 10,
				// limits: [10, 20, 30, 40, 50, 60, 70, 80, 90],
				where: { //设定异步数据接口的额外参数，任意设
					keyword: $('#keyword').val()
				},
				request: {
					pageName: 'pageNum', //页码的参数名称，默认：page
					limitName: 'pageSize' //每页数据量的参数名，默认：limit
				},
				parseData: function (res) {
					console.log(res);
					return {
						"code": 0,
						"msg": '',
						"count": res.data.total,
						"data": res.data.list,
					}
				},
				cols: [
					[ //表头
						{
							type: 'checkbox',
							fixed: 'left',
						},
						{
							field: 'userName',
							title: '账号',
						}, {
							field: 'name',
							title: '姓名',
						}, {
							field: 'roleName',
							title: '身份',
						}, {
							field: 'tel',
							title: '电话',
						}, {
							field: 'eval',
							title: '星级',
							sort: true
						}, {
							fixed: 'right',
							title: '操作',
							width: 260,
							toolbar: '#tableBar'
						}
					]
				]
			});
			//搜索按钮监听
			layui.$('#search').on('click', function () {
				var keyword = $("#keyword").val();
				var data = {
					keyword: keyword
				};
				// 重载数据
				table.reload('noticeData', {
					where: data,
					page: {
						curr: 1 //从第一页开始
					},
					url: baseUrl + '/user/queryUsers'
				});
			})

		});
	</script>
</body>

</html>